variables:
  IMAGE_NAME: tayeb517/juice-shop
  IMAGE_TAG: juice-shop-1.1

stages:
  - cache
  - sast
  - build
  - scan
  - dast  # Stage pour DAST
  
create_cache:
  image: node:18-bullseye
  stage: cache
  script:
    - rm -rf node_modules yarn.lock
    - yarn install --ignore-engines
  cache:
    key:
      files:
        - package.json
    paths:
      - node_modules/
      - yarn.lock
      - .yarn
    policy: pull-push

sonarqube_sast:
  stage: sast
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  cache:
    key: "sonar"
    paths:
      - .sonar/cache
  script:
    - echo "Using SONAR_TOKEN from GitLab CI variables"
    - sonar-scanner 
        -Dsonar.host.url="$SONAR_HOST_URL" 
        -Dsonar.token="$SONAR_TOKEN" 
        -Dsonar.projectKey="azizdaoues19_juice-shop" 
        -Dsonar.organization="azizdaoues19"
  artifacts:
    paths:
      - .scannerwork/
    expire_in: 7 days
  only:
    - branches
    - merge_requests

semgrep_sast:
  stage: sast
  image: returntocorp/semgrep
  script:
    - semgrep --config=auto --json --output=semgrep-report.json . || true
    - semgrep --config=auto --severity=ERROR --severity=WARNING .
  artifacts:
    paths:
      - semgrep-report.json
    expire_in: 7 days
    reports:
      sast: semgrep-report.json
  allow_failure: true

npm_audit:
  stage: sast
  image: node:18-bullseye
  script:
    - yarn install --ignore-engines
    - echo "Running npm audit..."
    - npm audit --json > npm-audit-report.json || true
    - npm audit --audit-level=moderate || true
  artifacts:
    paths:
      - npm-audit-report.json
    expire_in: 7 days
  cache:
    key:
      files:
        - package.json
    paths:
      - node_modules/
    policy: pull
  allow_failure: true

build_image:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin
  script:
    - docker build -t $IMAGE_NAME:$IMAGE_TAG .
    - docker push $IMAGE_NAME:$IMAGE_TAG
    - echo "BUILT_IMAGE=$IMAGE_NAME:$IMAGE_TAG" > build.env
  artifacts:
    expire_in: 1 day
    reports:
      dotenv: build.env

trivy_scan:
  stage: scan
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - apk add curl
    - docker login -u $DOCKER_USER -p $DOCKER_PASS
  script:
    - curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
    - trivy image --no-progress --severity HIGH,CRITICAL --output trivy-scanning-report.txt $IMAGE_NAME:$IMAGE_TAG
  artifacts:
    reports:
      container_scanning: trivy-scanning-report.txt
  dependencies:
    - build_image
  allow_failure: true

zap_dast:
  stage: dast
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    TARGET_URL: "http://docker:3000"
  before_script:
    - apk add --no-cache curl
  script:
    - echo "Starting Juice Shop application..."
    - docker run -d --name juice-shop-zap -p 3000:3000 $IMAGE_NAME:$IMAGE_TAG
    - sleep 30
    - echo "Waiting for application to be ready..."
    - |
      for i in $(seq 1 20); do
        if docker exec juice-shop-zap curl -sf http://localhost:3000 >/dev/null 2>&1; then
          echo "Application is ready"
          break
        fi
        echo "Waiting... ($i/20)"
        sleep 3
      done
    - echo "Running OWASP ZAP scan..."
    - docker run --rm --network container:juice-shop-zap -v $(pwd):/zap/wrk:rw ghcr.io/zaproxy/zaproxy:stable zap-baseline.py -t http://localhost:3000 -r zap-report.html -J zap-report.json || true
  after_script:
    - docker stop juice-shop-zap || true
    - docker rm juice-shop-zap || true
  artifacts:
    when: always
    paths:
      - zap-report.html
      - zap-report.json
    expire_in: 7 days
  allow_failure: true
  needs:
    - build_image

nikto_dast:
  stage: dast
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - apk add --no-cache curl
  script:
    - echo "Starting Juice Shop application for Nikto scan..."
    - docker run -d --name juice-shop-nikto -p 3001:3000 $IMAGE_NAME:$IMAGE_TAG
    - sleep 30
    - echo "Waiting for application to be ready..."
    - |
      for i in $(seq 1 20); do
        if docker exec juice-shop-nikto curl -sf http://localhost:3000 >/dev/null 2>&1; then
          echo "Application is ready"
          break
        fi
        echo "Waiting... ($i/20)"
        sleep 3
      done
    - echo "Running Nikto web vulnerability scan..."
    - docker run --rm --network container:juice-shop-nikto -v $(pwd):/tmp sullo/nikto -h http://localhost:3000 -Format htm -output /tmp/nikto-report.html || true
    - docker run --rm --network container:juice-shop-nikto -v $(pwd):/tmp sullo/nikto -h http://localhost:3000 -Format json -output /tmp/nikto-report.json || true
    - echo "Nikto scan completed"
  after_script:
    - docker stop juice-shop-nikto || true
    - docker rm juice-shop-nikto || true
  artifacts:
    when: always
    paths:
      - nikto-report.html
      - nikto-report.json
    expire_in: 7 days
  allow_failure: true
  needs:
    - build_image

arachni_dast:
  stage: dast
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - apk add --no-cache curl
  script:
    - echo "Starting Juice Shop application for Arachni scan..."
    - docker run -d --name juice-shop-arachni -p 3002:3000 $IMAGE_NAME:$IMAGE_TAG
    - sleep 30
    - echo "Waiting for application to be ready..."
    - |
      for i in $(seq 1 20); do
        if docker exec juice-shop-arachni curl -sf http://localhost:3000 >/dev/null 2>&1; then
          echo "Application is ready"
          break
        fi
        echo "Waiting... ($i/20)"
        sleep 3
      done
    - echo "Running Arachni web security scanner..."
    - docker run --rm --network container:juice-shop-arachni -v $(pwd):/arachni arachni/arachni:latest arachni http://localhost:3000 --report-save-path=/arachni/arachni-report.afr --checks=* --scope-include-subdomains || true
    - docker run --rm -v $(pwd):/arachni arachni/arachni:latest arachni_reporter /arachni/arachni-report.afr --reporter=html:outfile=/arachni/arachni-report.html || true
    - docker run --rm -v $(pwd):/arachni arachni/arachni:latest arachni_reporter /arachni/arachni-report.afr --reporter=json:outfile=/arachni/arachni-report.json || true
  after_script:
    - docker stop juice-shop-arachni || true
    - docker rm juice-shop-arachni || true
  artifacts:
    when: always
    paths:
      - arachni-report.html
      - arachni-report.json
      - arachni-report.afr
    expire_in: 7 days
  allow_failure: true
  needs:
    - build_image